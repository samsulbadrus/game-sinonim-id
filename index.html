<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inisialisasi Firebase yang Diperbaiki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
    </style>
</head>
<body class="p-6">

    <div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Status Aplikasi Firebase</h1>
        <p class="text-gray-600 mb-6">
            Aplikasi ini akan mencoba menginisialisasi Firebase dan melakukan autentikasi menggunakan kredensial lingkungan yang disediakan.
        </p>
        
        <div id="status-card" class="p-4 rounded-lg transition duration-300 ease-in-out">
            <p class="font-semibold" id="status">Memuat...</p>
        </div>

        <div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-700 border border-gray-200">
            <p><strong>Catatan:</strong> Pesan kesalahan "Kunci API masih placeholder" muncul ketika kode secara manual mendefinisikan konfigurasi Firebase dengan nilai dummy. Kode di bawah ini menggunakan variabel global `__firebase_config` dan `__initial_auth_token` untuk mengatasi masalah ini.</p>
        </div>
    </div>

    <!-- Modul Firebase -->
    <script type="module">
        // Import fungsi Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Atur level log ke Debug untuk melihat detail di konsol
        setLogLevel('debug'); 

        const statusElement = document.getElementById('status');
        const statusCard = document.getElementById('status-card');

        // Deklarasi global (atau let) agar bisa diakses di seluruh module
        let app;
        let auth;
        let db;
        
        // --- Wrapper Fungsi Utama untuk Memperbaiki "Illegal return statement" ---
        const main = async () => {

            // --- Langkah 1: Mendapatkan Konfigurasi ---
            let firebaseConfig;
            try {
                // Mengambil konfigurasi dari variabel global __firebase_config
                firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            } catch (e) {
                console.error("Gagal memparsing konfigurasi Firebase:", e);
                statusElement.textContent = "KESALAHAN KONFIGURASI: Gagal memproses variabel `__firebase_config`.";
                statusCard.classList.add('bg-red-100', 'text-red-700');
                return; // Return ini sekarang legal karena berada di dalam fungsi main()
            }

            // Memeriksa apakah konfigurasi valid
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YOUR_API_KEY')) {
                console.error("Konfigurasi Firebase tidak valid atau masih berupa placeholder.");
                statusElement.textContent = "KESALAHAN KONFIGURASI: Kredensial Firebase tidak valid atau hilang. Silakan periksa pengaturan lingkungan Anda.";
                statusCard.classList.add('bg-red-100', 'text-red-700');
                return; // Return ini sekarang legal karena berada di dalam fungsi main()
            }

            // --- Langkah 2: Inisialisasi Firebase ---
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase berhasil diinisialisasi.");
                statusElement.textContent = "Firebase berhasil diinisialisasi. Mencoba Autentikasi...";
                statusCard.classList.remove('bg-red-100', 'text-red-700');
                statusCard.classList.add('bg-yellow-100', 'text-yellow-700');
            } catch (error) {
                console.error("Gagal inisialisasi Firebase:", error);
                statusElement.textContent = `KESALAHAN INISIALISASI: ${error.message}`;
                statusCard.classList.remove('bg-yellow-100', 'text-yellow-700');
                statusCard.classList.add('bg-red-100', 'text-red-700');
                return; // Return ini sekarang legal karena berada di dalam fungsi main()
            }

            // --- Langkah 3: Autentikasi Pengguna ---
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    // Menggunakan token kustom yang disediakan lingkungan
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Autentikasi berhasil menggunakan token kustom.");
                    statusElement.textContent = `Autentikasi Berhasil! Pengguna ID: ${auth.currentUser.uid}`;
                } else {
                    // Masuk secara anonim jika tidak ada token kustom
                    await signInAnonymously(auth);
                    console.log("Autentikasi berhasil secara anonim.");
                    statusElement.textContent = `Autentikasi Berhasil (Anonim)! Pengguna ID: ${auth.currentUser.uid}`;
                }

                statusCard.classList.remove('bg-yellow-100', 'text-yellow-700');
                statusCard.classList.add('bg-green-100', 'text-green-700');

            } catch (error) {
                console.error("Gagal autentikasi Firebase:", error);
                statusElement.textContent = `KESALAHAN AUTENTIKASI: ${error.message}`;
                statusCard.classList.remove('bg-yellow-100', 'text-yellow-700');
                statusCard.classList.add('bg-red-100', 'text-red-700');
            }
        };

        // Mulai proses utama
        main();

    </script>
</body>
</html>
